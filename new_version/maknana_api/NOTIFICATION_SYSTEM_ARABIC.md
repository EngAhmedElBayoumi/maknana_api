# توثيق نظام الإشعارات في Django

## نظرة عامة

يصف هذا التوثيق نظام الإشعارات الشامل المطبق في مشروع Django REST Framework. يتتبع النظام جميع تغييرات النماذج باستخدام Django Signals ونموذج AuditLog، مع إمكانيات التسجيل في الوقت الفعلي عبر تكامل Pusher.

## الميزات

- **تسجيل شامل للعمليات**: يتتبع جميع عمليات الإنشاء والتحديث والحذف على أي نموذج
- **إشعارات في الوقت الفعلي**: يستخدم Pusher لإرسال إشعارات فورية للعملاء المتصلين
- **تتبع المستخدمين**: يسجل أي مستخدم قام بكل عملية
- **تتبع التغييرات**: يحفظ معلومات مفصلة حول ما تم تغييره
- **REST API**: يوفر نقاط نهاية شاملة للوصول إلى بيانات التدقيق
- **واجهة الإدارة**: تكامل مع إدارة Django لعرض سجلات التدقيق
- **لوحة التحكم**: لوحة تحكم في الوقت الفعلي لمراقبة نشاط النظام
- **التصفية والبحث**: إمكانيات متقدمة للتصفية والبحث

## التثبيت والإعداد

### 1. تثبيت التطبيق

تم إنشاء تطبيق الإشعارات وإضافته إلى مشروع Django الخاص بك:

```python
# في project/settings.py
INSTALLED_APPS = [
    # ... تطبيقات أخرى
    'notification',
    'django_filters',
]
```

### 2. إعداد Middleware

تم إضافة AuditMiddleware لالتقاط المستخدم الحالي:

```python
# في project/settings.py
MIDDLEWARE = [
    # ... middleware أخرى
    'notification.signals.AuditMiddleware',
    # ... باقي middleware
]
```

### 3. إعداد Pusher

تم تكوين بيانات اعتماد Pusher بالفعل في الإعدادات:

```python
# في project/settings.py
PUSHER_APP_ID = "2008598"
PUSHER_KEY = "cf5338c234a513e939b6"
PUSHER_SECRET = "ad58023a7719d524fbe0"
PUSHER_CLUSTER = "eu"
```

### 4. ترحيل قاعدة البيانات

قم بتشغيل الترحيلات لإنشاء جدول سجل التدقيق:

```bash
python manage.py makemigrations notification
python manage.py migrate
```

## النماذج

### نموذج AuditLog

النموذج الرئيسي الذي يحفظ جميع معلومات التدقيق:

```python
class AuditLog(models.Model):
    ACTION_CHOICES = [
        ('created', 'تم الإنشاء'),
        ('updated', 'تم التحديث'),
        ('deleted', 'تم الحذف'),
    ]

    user = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True)
    action = models.CharField(max_length=10, choices=ACTION_CHOICES)
    timestamp = models.DateTimeField(auto_now_add=True)
    content_type = models.ForeignKey(ContentType, on_delete=models.CASCADE)
    object_id = models.PositiveIntegerField()
    content_object = GenericForeignKey('content_type', 'object_id')
    changes = models.JSONField(null=True, blank=True)
    model_name = models.CharField(max_length=255, blank=True)
    object_repr = models.CharField(max_length=200, blank=True)
```

**الحقول:**
- `user`: المستخدم الذي قام بالعملية (قابل للإلغاء للعمليات المجهولة)
- `action`: نوع العملية (إنشاء، تحديث، حذف)
- `timestamp`: وقت حدوث العملية
- `content_type`: نوع المحتوى Django للنموذج المتأثر
- `object_id`: المفتاح الأساسي للكائن المتأثر
- `content_object`: مفتاح خارجي عام للكائن الفعلي
- `changes`: حقل JSON يحتوي على التغييرات المجراة
- `model_name`: اسم فئة النموذج
- `object_repr`: تمثيل نصي للكائن

## نقاط نهاية API

### الرابط الأساسي: `/api/notifications/`

### 1. قائمة سجلات التدقيق
- **الرابط**: `GET /api/notifications/audit-logs/`
- **الوصف**: عرض جميع سجلات التدقيق مع التصفية والترقيم
- **المصادقة**: مطلوبة
- **المرشحات**:
  - `action`: تصفية حسب نوع العملية (إنشاء، تحديث، حذف)
  - `model_name`: تصفية حسب اسم النموذج
  - `user`: تصفية حسب بريد المستخدم الإلكتروني
  - `date_from`: تصفية من تاريخ
  - `date_to`: تصفية إلى تاريخ
- **البحث**: البحث في بريد المستخدم، اسم النموذج، تمثيل الكائن، والتغييرات
- **الترتيب**: حسب الوقت، العملية، اسم النموذج

### 2. تفاصيل سجل التدقيق
- **الرابط**: `GET /api/notifications/audit-logs/{id}/`
- **الوصف**: الحصول على معلومات مفصلة حول سجل تدقيق محدد
- **المصادقة**: مطلوبة

### 3. الإحصائيات
- **الرابط**: `GET /api/notifications/statistics/`
- **الوصف**: الحصول على إحصائيات سجلات التدقيق
- **المصادقة**: مطلوبة

### 4. نشاط المستخدم
- **الرابط**: `GET /api/notifications/user-activity/`
- **الرابط**: `GET /api/notifications/user-activity/{email}/`
- **الوصف**: الحصول على سجلات النشاط للمستخدم الحالي أو مستخدم محدد
- **المصادقة**: مطلوبة

### 5. نشاط النموذج
- **الرابط**: `GET /api/notifications/model-activity/{model_name}/`
- **الوصف**: الحصول على سجلات النشاط لنموذج محدد
- **المصادقة**: مطلوبة

### 6. اختبار الإشعار
- **الرابط**: `POST /api/notifications/test-notification/`
- **الوصف**: إرسال إشعار تجريبي في الوقت الفعلي
- **المصادقة**: مطلوبة

### 7. لوحة التحكم
- **الرابط**: `GET /api/notifications/dashboard/`
- **الوصف**: عرض لوحة التحكم في الوقت الفعلي
- **المصادقة**: غير مطلوبة (لكن موصى بها)

## الإشعارات في الوقت الفعلي

### قنوات Pusher

يستخدم النظام ثلاثة أنواع من قنوات Pusher:

1. **قناة التدقيق العامة**: `audit-channel`
   - الحدث: `model-change`
   - تستقبل جميع تغييرات النماذج

2. **القنوات الخاصة بالنماذج**: `model-{model_name}`
   - الحدث: `change`
   - تستقبل التغييرات للنماذج المحددة

3. **القنوات الخاصة بالمستخدمين**: `user-{user_email}`
   - الحدث: `activity`
   - تستقبل الأنشطة للمستخدمين المحددين

### تنسيق بيانات الإشعار

```json
{
    "action": "created",
    "model": "service",
    "object_id": 53,
    "user": "test@example.com",
    "timestamp": "2025-01-07T12:04:26.123456Z",
    "changes": {
        "name": {"old": null, "new": "خدمة تجريبية"}
    }
}
```

## كيف يعمل النظام

### 1. معالجة الإشارات

تُستخدم إشارات Django لالتقاط تغييرات النماذج تلقائياً:

```python
@receiver(post_save)
def log_model_save(sender, instance, created, **kwargs):
    # إنشاء إدخال سجل التدقيق
    # إرسال إشعار في الوقت الفعلي

@receiver(post_delete)
def log_model_delete(sender, instance, **kwargs):
    # إنشاء إدخال سجل التدقيق للحذف
    # إرسال إشعار في الوقت الفعلي
```

### 2. تتبع المستخدمين

يلتقط `AuditMiddleware` المستخدم الحالي من الطلب ويحفظه في التخزين المحلي للخيط، مما يجعله متاحاً لمعالجات الإشارات.

### 3. تتبع التغييرات

- لعمليات الإنشاء: يتم تسجيل جميع قيم الحقول كقيم "جديدة"
- لعمليات التحديث: يسجل النظام التغييرات (ملاحظة: القيم القديمة غير متتبعة في هذا التطبيق للبساطة)
- لعمليات الحذف: يتم تسجيل جميع قيم الحقول كقيم "قديمة"

### 4. الإشعارات في الوقت الفعلي

عند حدوث تغيير في النموذج، يقوم معالج الإشارة بـ:
1. إنشاء إدخال سجل تدقيق
2. إرسال إشعار في الوقت الفعلي عبر Pusher إلى قنوات متعددة

## الاختبار

يتم توفير نص اختبار شامل في `test_notification_system.py`. قم بتشغيله للتحقق من النظام:

```bash
python test_notification_system.py
```

يتحقق نص الاختبار من:
- تسجيل التدقيق لعمليات الإنشاء والتحديث والحذف
- إرسال الإشعارات في الوقت الفعلي
- وظائف نقاط نهاية API

## واجهة الإدارة

سجلات التدقيق متاحة في إدارة Django في `/admin/notification/auditlog/` مع:
- عرض قائمة مع تصفية حسب العملية والنموذج والوقت والمستخدم
- وظيفة البحث
- عرض تفصيلي للقراءة فقط
- لا توجد أذونات إضافة/تعديل/حذف (لا يجب تعديل سجلات التدقيق)

## اعتبارات الأمان

1. **المصادقة**: جميع نقاط نهاية API تتطلب مصادقة
2. **القراءة فقط**: لا يمكن تعديل سجلات التدقيق عبر API
3. **خصوصية المستخدم**: معلومات المستخدم محدودة بالبريد الإلكتروني والاسم
4. **الاحتفاظ بالبيانات**: فكر في تطبيق سياسات الاحتفاظ بالبيانات لسجلات التدقيق القديمة

## اعتبارات الأداء

1. **تأثير قاعدة البيانات**: كل عملية نموذج تنشئ إدخال سجل تدقيق
2. **حدود Pusher**: كن على علم بحدود الرسائل وأسعار Pusher
3. **التخزين**: يمكن أن تنمو سجلات التدقيق بشكل كبير مع الوقت
4. **الفهرسة**: فكر في إضافة فهارس قاعدة البيانات للحقول المستعلمة بكثرة

## استكشاف الأخطاء وإصلاحها

### المشاكل الشائعة

1. **لا يتم إنشاء سجلات تدقيق**: تحقق من تكوين middleware بشكل صحيح
2. **الإشعارات في الوقت الفعلي لا تعمل**: تحقق من بيانات اعتماد Pusher واتصال الشبكة
3. **أخطاء الأذونات**: تأكد من المصادقة المناسبة لنقاط نهاية API

## التحسينات المستقبلية

التحسينات المحتملة للنظام:

1. **تتبع القيم القديمة**: تطبيق تتبع مناسب للقيم القديمة لعمليات التحديث
2. **العمليات المجمعة**: التعامل مع عمليات الإنشاء/التحديث/الحذف المجمعة
3. **تغييرات الملفات**: تتبع تغييرات رفع/حذف الملفات
4. **إشعارات البريد الإلكتروني**: إضافة إشعارات بريد إلكتروني للتغييرات الحرجة
5. **Webhooks**: إضافة دعم webhook للتكاملات الخارجية
6. **الاحتفاظ بالبيانات**: تطبيق تنظيف تلقائي لسجلات التدقيق القديمة
7. **تحسين الأداء**: إضافة التخزين المؤقت وتحسين استعلامات قاعدة البيانات

## الخلاصة

يوفر نظام الإشعارات تسجيل تدقيق شامل وإشعارات في الوقت الفعلي لتطبيق Django الخاص بك. يتتبع تلقائياً جميع تغييرات النماذج، ويوفر وصولاً مفصلاً لبيانات التدقيق عبر API، ويرسل إشعارات فورية للعملاء المتصلين.

النظام مصمم ليكون:
- **تلقائي**: لا حاجة لتغييرات في الكود للنماذج الموجودة
- **شامل**: يتتبع جميع عمليات النماذج
- **في الوقت الفعلي**: إشعارات فورية عبر Pusher
- **آمن**: مصادقة مناسبة ووصول للقراءة فقط
- **قابل للتوسع**: تصميم قاعدة بيانات فعال وترقيم API

لأي أسئلة أو مشاكل، ارجع إلى نص الاختبار وهذا التوثيق.

